<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Bóveda Financiera Pro</title>
    <style>
        :root {
            --bg-body: #f0f2f5; --bg-card: #ffffff; --text-main: #1c1e21; --text-muted: #65676b;
            --primary: #1877f2; --ingreso: #36a420; --egreso: #d32f2f; --deuda: #f57c00; --gold: #ffd700;
            --excel: #107c41; --purple: #6d5a73; --activo: #17a2b8; --danger: #dc3545;
            --border: #dadde1; --shadow: 0 2px 4px rgba(0, 0, 0, 0.1); --radius: 12px;
        }
        body.dark-mode {
            --bg-body: #18191a; --bg-card: #242526; --text-main: #e4e6eb; --text-muted: #b0b3b8;
            --primary: #4599ff; --border: #3e4042; --shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }
        
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; transition: background 0.3s ease, color 0.3s ease; }
        body.no-scroll { overflow: hidden; } 
        h2, h3, h4 { margin-top: 0; font-weight: 600; }
        
        button { cursor: pointer; padding: 10px 16px; border: none; border-radius: 8px; background: var(--primary); color: white; font-weight: 600; font-size: 14px; transition: all 0.2s; outline: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        button:hover { filter: brightness(1.1); transform: translateY(-1px); }
        
        input, select, textarea { padding: 12px; width: 100%; box-sizing: border-box; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-card); color: var(--text-main); font-size: 14px; outline: none; font-family: inherit; transition: border-color 0.3s ease; }
        input:focus, select:focus { border-color: var(--primary); }
        textarea { min-height: 80px; resize: vertical; }
        input[type="date"] { padding: 8px 12px; }

        .fade-in { animation: smoothFadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes smoothFadeIn { 
            0% { opacity: 0; transform: translateY(8px); } 
            100% { opacity: 1; transform: translateY(0); } 
        }
        .hidden { display: none !important; }

        #login-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(5px); }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(4px); }
        #custom-alert-modal, #confirm-modal { z-index: 3000; }
        
        .login-card { background: var(--bg-card); padding: 40px 30px; border-radius: 16px; width: 340px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: smoothFadeIn 0.4s ease-out; }
        .modal-card { background: var(--bg-card); padding: 30px; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; animation: smoothFadeIn 0.3s ease-out; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border); }
        
        #app-container { display: none; max-width: 1050px; margin: 30px auto; padding: 0 20px 50px 20px; }
        
        .app-header-premium { display: flex; justify-content: space-between; align-items: center; background: var(--bg-card); padding: 20px 25px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 25px; }
        .header-brand { display: flex; align-items: center; gap: 15px; }
        
        .brand-icon-box { background: linear-gradient(135deg, var(--primary) 0%, #0056b3 100%); color: white; width: 48px; height: 48px; border-radius: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease-in-out; box-shadow: none; }
        .brand-icon-box:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(24, 119, 242, 0.3); }
        
        .brand-text-container { display: flex; flex-direction: column; }
        .brand-text-container h2 { margin: 0; font-size: 1.6em; color: var(--text-main); letter-spacing: -0.5px; line-height: 1.1; }
        
        .session-trigger { font-size: 12px; font-weight: 500; color: var(--text-muted); margin-top: 0px; cursor: pointer; transition: all 0.2s; padding: 2px 6px; margin-left: -6px; border-radius: 6px; user-select: none; display: inline-block; }
        .session-trigger:hover { background: rgba(0,0,0,0.04); color: var(--primary); } 
        #session-history-container { margin-top: 5px; padding-left: 8px; border-left: 2px solid var(--border); display: flex; flex-direction: column; gap: 3px; }
        .session-history-item { font-size: 11px; color: var(--text-muted); }

        .header-actions { display: flex; gap: 12px; align-items: center; }
        .btn-header { height: 42px; padding: 0 18px; border-radius: 8px; font-weight: 600; font-size: 14px; transition: all 0.2s; box-sizing: border-box; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-header-primary { background: var(--primary); color: white; }
        .btn-header-primary:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-header-outline { background: rgba(24, 119, 242, 0.1); color: var(--primary); }
        .btn-header-outline:hover { background: var(--primary); color: white; transform: translateY(-1px); }

        .tabs { display: flex; background: var(--bg-card); padding: 5px; border-radius: var(--radius); margin-bottom: 25px; box-shadow: var(--shadow); overflow-x: auto;}
        .tab-btn { flex: 1; background: transparent; color: var(--text-muted); padding: 12px; border-radius: 10px; font-weight: 600; transition: background-color 0.3s ease-out, color 0.3s ease-out; white-space: nowrap; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; } .tab-content.active { display: block; }

        .banner-patrimonio-clickable { background: var(--bg-card); border-radius: var(--radius); padding: 20px 25px; box-shadow: var(--shadow); margin-bottom: 30px; border-left: 5px solid var(--primary); display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .banner-patrimonio-clickable:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .banner-patrimonio-clickable h3 { color: var(--text-muted); font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 5px 0; display: flex; align-items: center; gap: 5px;}
        .banner-patrimonio-clickable .monto { color: var(--primary); font-size: 2.5em; font-weight: 800; margin: 0; line-height: 1; }

        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--bg-card); padding: 25px 25px 35px 25px; border-radius: var(--radius); box-shadow: var(--shadow); transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); border: 2px solid transparent; cursor: pointer; position: relative; overflow: hidden; display: flex; flex-direction: column;}
        .card:hover { transform: translateY(-4px); border-color: var(--primary); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .card.active-detail { border-color: var(--primary); background: rgba(24, 119, 242, 0.05); }
        .card::after { content: 'Ver detalles de hoy ↓'; position: absolute; bottom: 0; left: 0; width: 100%; text-align: center; font-size: 10px; background: rgba(0,0,0,0.05); color: var(--text-muted); padding: 5px 0; opacity: 0; transition: opacity 0.3s ease; }
        .card:hover::after { opacity: 1; }
        .card-label { font-size: 0.85em; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; line-height: 1.4; margin-bottom: 15px;} 
        .card-bottom-content { margin-top: auto; }
        .saldo-txt { font-size: 2.2em; margin: 0 0 5px 0; font-weight: 700; }
        .txt-verde { color: var(--ingreso); } .txt-rojo { color: var(--egreso); } .txt-amarillo { color: var(--deuda); }
        .card-pct { font-size: 12px; font-weight: 600; color: var(--text-muted); opacity: 0.9; height: 35px; display: block; overflow: hidden;}
        
        #detalle-inline-container { background: var(--bg-card); margin-top: -20px; margin-bottom: 30px; border-radius: 0 0 var(--radius) var(--radius); box-shadow: var(--shadow); overflow: hidden; max-height: 0; transition: max-height 0.5s cubic-bezier(0.16, 1, 0.3, 1), padding 0.5s ease; border: 1px solid var(--border); border-top: none; }
        #detalle-inline-container.open { max-height: 500px; padding: 20px; overflow-y: auto; }
        #detalle-inline-titulo { padding-left: 16px; margin: 15px 0 15px 0; color: var(--primary); }

        .grafico-container { background: var(--bg-card); padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 30px; display: flex; flex-direction: column; align-items: center; max-width: 700px; margin-left: auto; margin-right: auto;}
        .pie-chart-wrapper { position: relative; width: 220px; height: 220px; margin: 20px 0; }
        .pie-chart { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; background: conic-gradient(var(--border) 0% 100%); box-shadow: inset 0 0 0 5px rgba(0,0,0,0.05); transition: background 1s ease-out; }
        .pie-hole { position: absolute; top: 50%; left: 50%; width: 65%; height: 65%; background: var(--bg-card); border-radius: 50%; transform: translate(-50%, -50%); box-shadow: var(--shadow); display: flex; justify-content: center; align-items: center; text-align: center; flex-direction: column;}
        .leyenda-grafico { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; width: 100%; max-width: 500px;}
        .leyenda-item { display: flex; align-items: center; justify-content: space-between; font-size: 13px; font-weight: 600; background: rgba(0,0,0,0.02); padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border);}
        .leyenda-color-txt { display: flex; align-items: center; }
        .color-dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }

        .table-container { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); overflow-x: auto;}
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 14px 16px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: rgba(0,0,0,0.02); font-size: 0.85em; text-transform: uppercase; color: var(--text-muted); }
        tr:last-child td { border-bottom: none; }

        .fin-align { text-align: right; font-variant-numeric: tabular-nums; white-space: nowrap; }

        .movimientos-header { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .movimientos-actions-top { display: flex; justify-content: flex-end; }
        .btn-excel { background: var(--excel); color: white; } .btn-excel:hover { background: #0c5e31; }
        .filtros-container-unified { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; background: var(--bg-card); padding: 15px; border-radius: var(--radius); border: 1px solid var(--border); }
        .filtro-group { display: flex; align-items: center; border: 1px solid var(--border); border-radius: 8px; padding: 0 10px; background: rgba(0,0,0,0.02); }
        .filtro-group span { font-size: 13px; font-weight: 600; color: var(--text-muted); margin-right: 5px; }
        .filtro-group input, .filtro-group select { border: none; background: transparent; margin-bottom: 0; padding: 8px; }
        #fila-subfiltros { display: flex; gap: 10px; width: 100%; }

        .activos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .activo-card { background: var(--bg-card); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); position: relative;}
        .activo-card:hover { transform: translateY(-4px); border-color: var(--activo); }
        .activo-cat-badge { display: inline-block; background: rgba(23, 162, 184, 0.1); color: var(--activo); padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; text-transform: uppercase; margin-bottom: 10px; }
        .activo-titulo { font-size: 16px; font-weight: 700; margin: 0 0 15px 0; color: var(--text-main); }
        .activo-valor { font-size: 20px; font-weight: 700; color: var(--activo); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;}
        
        .metas-top-bar { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid var(--border); padding-bottom: 15px; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;}
        .sub-tabs-container { display: flex; gap: 20px; }
        .sub-tab-btn { background: none; border: none; padding: 10px 5px; font-weight: 600; color: var(--text-muted); cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s ease; font-size: 14px; border-radius: 0; margin-bottom: -17px; }
        .sub-tab-btn:hover { color: var(--text-main); }
        .sub-tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        .metas-grid-compact { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .meta-card-compact { background: var(--bg-card); border-radius: 16px; overflow: hidden; box-shadow: var(--shadow); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); position: relative; border: 2px solid transparent; cursor: pointer; }
        .meta-card-compact:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 20px rgba(0,0,0,0.15);}
        .meta-card-compact.cumplida { border-color: var(--gold); }
        .meta-card-compact.archivada { filter: grayscale(0.8); opacity: 0.8; border-color: var(--border) !important; }
        .meta-card-compact.archivada:hover { filter: grayscale(0); opacity: 1; border-color: var(--text-muted) !important; transform: translateY(-2px); }
        
        .badge-cumplida { position: absolute; top: 10px; right: 10px; background: var(--gold); color: #333; font-size: 10px; font-weight: bold; padding: 4px 8px; border-radius: 10px; z-index: 2; }
        .badge-archivada { position: absolute; top: 10px; right: 10px; background: var(--text-muted); color: white; font-size: 10px; font-weight: bold; padding: 4px 8px; border-radius: 10px; z-index: 2; }

        .meta-img-box { width: 100%; height: 130px; background: #eee; } .meta-img-box img { width: 100%; height: 100%; object-fit: cover; }
        .meta-info { padding: 15px; text-align: center; }
        .meta-title { font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 5px;}
        .barra-progreso-mini { width: 100%; background: var(--border); height: 8px; border-radius: 4px; margin-bottom: 8px; overflow: hidden; }
        .progreso-fill-mini { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s ease; }
        .meta-card-compact.cumplida .progreso-fill-mini { background: var(--ingreso); }

        #md-historial-container { overflow-y: auto; max-height: 180px; padding-right: 5px; }
        #md-historial-container::-webkit-scrollbar { width: 4px; }
        #md-historial-container::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.2); border-radius: 4px; }
        .historial-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
        .historial-item:last-child { border-bottom: none; }
        .historial-fecha { color: var(--text-main); }
        
        .config-profile-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .profile-avatar { width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; font-weight: bold; overflow: hidden; border: 2px solid var(--bg-card); box-shadow: var(--shadow); margin-right: 15px;}
        .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .profile-btn { padding: 8px 12px; border-radius: 8px; font-weight: 600; font-size: 13px; transition: all 0.2s; border: 1px solid transparent; display: inline-flex; align-items: center; }
        .btn-edit-profile { background: var(--purple); color: white; } .btn-edit-profile:hover { background: #5a4a5f; }
        .btn-logout { background: var(--danger); color: white; padding: 8px; } .btn-logout:hover { background: #b02a37; }
        .config-item { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: var(--bg-card); border-radius: var(--radius); margin-bottom: 15px; box-shadow: var(--shadow); }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; } .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); } input:checked + .slider:before { transform: translateX(24px); }

        .custom-file-container { display: flex; align-items: center; border: 1px solid var(--border); border-radius: 8px; padding: 5px; background: var(--bg-card); height: 43px; box-sizing: border-box; width: 100%; margin-bottom: 15px; }
        .custom-file-btn { background: rgba(0,0,0,0.05); color: var(--text-main); padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 600; margin-right: 10px; transition: background 0.3s ease; flex-shrink: 0;}
        .file-name-display { font-size: 12px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        .btn-secondary { background: transparent; color: var(--text-muted); border: 1px solid var(--border); } .btn-secondary:hover { background: rgba(0,0,0,0.03); color: var(--text-main); border-color: var(--text-muted); }
        .link-historial { font-size: 12px; color: var(--primary); cursor: pointer; font-weight: 600; margin-top: 5px; display: inline-block; } .link-historial:hover { text-decoration: underline; }
        input[type="file"] { display: none; }
        .btn-danger-text { color: var(--danger); border-color: transparent; } .btn-danger-text:hover { background: rgba(220, 53, 69, 0.1); color: var(--danger); border-color: transparent;}
    </style>
</head>
<body>

    <div id="tohka-modal" class="modal-overlay" onclick="toggleTohkaModal(false)" style="z-index: 4000; cursor: pointer; background: black; display: none; flex-direction: column; justify-content: center; align-items: center;">
        <div style="color: white; font-size: 3em; font-weight: 800; letter-spacing: 4px; text-shadow: 0 0 20px rgba(255,255,255,0.5); font-family: 'Segoe UI', sans-serif;">
            TOHKA S.A.
        </div>
        <div style="color: rgba(255,255,255,0.6); font-size: 1rem; margin-top: 15px; font-weight: normal;">
            © Todos los derechos reservados
        </div>
    </div>

    <div id="custom-alert-modal" class="modal-overlay" style="z-index: 3000;">
        <div class="modal-card" style="width: 350px; text-align: center;">
            <h3 id="alert-title" style="color: var(--primary); margin-bottom: 10px;"></h3>
            <p id="alert-message" style="color: var(--text-muted); font-size: 14px; margin-bottom: 25px; white-space: pre-wrap; line-height: 1.5;"></p>
            <button onclick="cerrarModal('custom-alert-modal')" style="width: 100%;">Aceptar</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay" style="z-index: 3001;">
        <div class="modal-card" style="width: 350px; text-align: center;">
            <h3 style="color: var(--primary); margin-bottom: 10px;" id="confirm-title">¿Estás seguro?</h3>
            <p id="confirm-message" style="color: var(--text-muted); font-size: 14px; margin-bottom: 25px; white-space: pre-wrap; line-height: 1.5;"></p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="cerrarModal('confirm-modal')" class="btn-secondary" id="btn-confirm-cancel">Cancelar</button>
                <button id="btn-confirm-action" style="background: var(--primary); color: white;">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="login-modal">
        <div class="login-card">
            <h2 style="color: var(--primary); margin-bottom: 10px;">Bienvenido</h2>
            <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 25px;">Accede a tu bóveda financiera personal</p>
            <input type="text" value="Servidor: SERVTOHKA4" disabled style="opacity: 0.7; background: rgba(0,0,0,0.03); font-weight: bold; text-align: center;">
            <input type="text" id="login-user" placeholder="Usuario" onkeypress="if(event.key === 'Enter') iniciarSesion()">
            <input type="password" id="login-pass" placeholder="Contraseña" onkeypress="if(event.key === 'Enter') iniciarSesion()">
            <label style="display:block; margin-bottom: 8px; text-align: left; font-size: 13px; font-weight: 600; color: var(--text-muted);">Bóveda (.json):</label>
            <div class="custom-file-container" style="margin-bottom: 20px;">
                <label for="login-file" class="custom-file-btn">Seleccionar archivo</label>
                <span id="login-file-name" class="file-name-display">Ningún archivo seleccionado</span>
                <input type="file" id="login-file" accept=".json" onchange="actualizarNombreArchivo(this, 'login-file-name')">
            </div>
            <button onclick="iniciarSesion()" style="width: 100%; margin-bottom: 15px;">Autenticar</button>
            <div style="border-top: 1px solid var(--border); padding-top: 15px;">
                <span style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 8px;">¿Eres un usuario nuevo?</span>
                <button onclick="abrirModalCrearBoveda()" class="btn-secondary" style="width: 100%;">Generar Bóveda</button>
            </div>
        </div>
    </div>

    <div id="app-container">
        
        <div class="app-header-premium">
            <div class="header-brand">
                <div class="brand-icon-box" onclick="toggleTohkaModal(true)" title="Tohka S.A.">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div class="brand-text-container">
                    <h2>Control Financiero</h2>
                    <div id="last-session-trigger" class="session-trigger" onclick="toggleSessionHistory()">Última sesión: Cargando...</div>
                    <div id="session-history-container" class="hidden fade-in"></div>
                </div>
            </div>
            <div class="header-actions" id="botones-dashboard">
                <button class="btn-header btn-header-primary" onclick="abrirModalRegistro()">+ Nuevo Movimiento</button>
                <button class="btn-header btn-header-outline" onclick="descargarRespaldo()" title="Guardar Respaldo en PC">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>
                    Respaldo
                </button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="cambiarPestana('vista-general', this)">Vista general</button>
            <button class="tab-btn" onclick="cambiarPestana('patrimonio', this)">Patrimonio (Activos)</button>
            <button class="tab-btn" onclick="cambiarPestana('movimientos', this)">Movimientos</button>
            <button class="tab-btn" onclick="cambiarPestana('metas', this)">Metas</button>
            <button class="tab-btn" onclick="cambiarPestana('configuracion', this)">Configuración</button>
        </div>

        <div id="vista-general" class="tab-content active fade-in">
            
            <div class="cards-grid">
                <div class="card" onclick="toggleDetalleInline('saldo', this)">
                    <span class="card-label">Liquidez Total<br><small style="text-transform:none; font-weight:normal;">(Disponible)</small></span>
                    <div class="card-bottom-content">
                        <div class="saldo-txt txt-verde" id="dash-saldo">$0.00</div>
                        <div class="card-pct" id="dash-pct-saldo">0% del capital real</div>
                    </div>
                </div>
                
                <div class="card" onclick="toggleDetalleInline('egresos', this)">
                    <span class="card-label">Egresos<br><small style="text-transform:none; font-weight:normal;">(Acumulados)</small></span>
                    <div class="card-bottom-content">
                        <div class="saldo-txt txt-rojo" id="dash-egresos">$0.00</div>
                        <div class="card-pct" id="dash-pct-egresos">Ratio de gasto: 0%</div>
                    </div>
                </div>

                <div class="card" onclick="toggleDetalleInline('ahorros', this)">
                    <span class="card-label">Capital Reservado<br><small style="text-transform:none; font-weight:normal;">(Metas)</small></span>
                    <div class="card-bottom-content">
                        <div class="saldo-txt" style="color: var(--primary);" id="dash-ahorros">$0.00</div>
                        <div class="card-pct" id="dash-pct-ahorros">0% del capital real</div>
                    </div>
                </div>
                
                <div class="card" onclick="toggleDetalleInline('deudas', this)">
                    <span class="card-label">Pasivo Corriente<br><small style="text-transform:none; font-weight:normal;">(Deudas)</small></span>
                    <div class="card-bottom-content">
                        <div class="saldo-txt txt-amarillo" id="dash-deudas">$0.00</div>
                        <div class="card-pct" id="dash-pct-deudas">Ratio de endeudamiento: 0%</div>
                    </div>
                </div>
            </div>
            
            <div id="detalle-inline-container"><h3 id="detalle-inline-titulo">Detalles</h3><div class="table-container"><table><thead><tr><th>Fecha</th><th>Detalle</th><th>Tipo</th><th>Monto</th><th>Saldo</th></tr></thead><tbody id="tabla-detalle-inline"></tbody></table></div></div>

            <div class="banner-patrimonio-clickable fade-in" onclick="clickBannerPatrimonio()">
                <div>
                    <h3 title="Fórmula: (Activos Fijos + Liquidez + Ahorros) - Deudas Totales">Patrimonio Neto Real ⓘ</h3>
                </div>
                <div class="monto" id="dash-patrimonio-neto">$0.00</div>
            </div>

            <div class="grafico-container fade-in">
                <h3 style="color: var(--text-muted); margin-bottom: 5px;">A dónde va tu dinero (Distribución de Ingresos)</h3>
                <div class="pie-chart-wrapper">
                    <div id="css-pie-chart" class="pie-chart"></div>
                    <div class="pie-hole"><span style="font-size: 12px; color: var(--text-muted);">Total Ingresado</span><span id="total-flujo" style="font-weight: bold; font-size: 18px;">$0</span></div>
                </div>
                <div class="leyenda-grafico">
                    <div class="leyenda-item"><div class="leyenda-color-txt"><div class="color-dot" style="background: var(--ingreso);"></div>Disponible</div><span id="pct-ingreso">$0.00 (0%)</span></div>
                    <div class="leyenda-item"><div class="leyenda-color-txt"><div class="color-dot" style="background: var(--primary);"></div>Ahorrado</div><span id="pct-ahorro">$0.00 (0%)</span></div>
                    <div class="leyenda-item"><div class="leyenda-color-txt"><div class="color-dot" style="background: var(--egreso);"></div>Gastado</div><span id="pct-egreso">$0.00 (0%)</span></div>
                </div>
            </div>
        </div>

        <div id="patrimonio" class="tab-content fade-in">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <div>
                    <h3 style="margin: 0 0 5px 0; color: var(--text-main); font-size: 1.5em;">Mis Activos Fijos</h3>
                    <p style="margin:0; font-size: 13px; color: var(--text-muted);">Registra tus bienes de valor (Vehículos, Inmuebles, Tecnología) para calcular tu Riqueza Real.</p>
                </div>
                <button onclick="abrirModalActivo()" style="background: var(--activo);">+ Registrar Activo</button>
            </div>

            <div class="activos-grid" id="contenedor-activos">
            </div>
        </div>

        <div id="movimientos" class="tab-content fade-in">
            <div class="movimientos-header">
                <div class="movimientos-actions-top">
                    <button onclick="exportarCSV()" class="btn-excel"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>Exportar Excel</button>
                </div>
                <div class="filtros-container-unified">
                    <div class="filtro-group"><span>Desde:</span><input type="date" id="filtro-inicio"></div>
                    <div class="filtro-group"><span>Hasta:</span><input type="date" id="filtro-fin"></div>
                    <div class="filtro-group"><span>Tipo:</span><select id="filtro-tipo" onchange="verificarSubfiltrosMovimientos()"><option value="Todos">Todos</option><option value="Ingreso">Ingresos</option><option value="Egreso">Egresos</option><option value="Ahorro">Ahorros</option><option value="Deuda">Adquisición Deudas</option><option value="PagoDeuda">Pagos a Deuda</option><option value="Reverso">Reversos</option><option value="UsoAhorro">Uso de Ahorros</option></select></div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="aplicarFiltrosAvanzados()" style="padding: 8px 15px;">Filtrar</button>
                        <button onclick="limpiarFiltrosAvanzados()" class="btn-secondary" style="padding: 8px 15px;">Limpiar</button>
                    </div>
                    <div id="fila-subfiltros" class="hidden">
                        <div class="filtro-group hidden" id="caja-filtro-ahorro" style="flex: 1;"><span>Subtipo:</span><select id="filtro-ahorro-select" style="width: 100%;"></select></div>
                        <div class="filtro-group hidden" id="caja-filtro-deuda" style="flex: 1;"><span>Etiqueta:</span><select id="filtro-deuda-select" style="width: 100%;"></select></div>
                    </div>
                </div>
            </div>
            <div class="table-container">
                <table><thead><tr><th>Fecha</th><th>Tipo</th><th>Detalle</th><th>Monto</th><th>Saldo Acumulado</th></tr></thead><tbody id="tabla-movimientos"></tbody></table>
            </div>
        </div>

        <div id="metas" class="tab-content fade-in">
            <div class="metas-top-bar">
                <div>
                    <h3 style="margin: 0 0 15px 0; color: var(--text-main); font-size: 1.5em;">Gestión de Objetivos</h3>
                    <div class="sub-tabs-container">
                        <button class="sub-tab-btn active" onclick="cambiarSubPestanaMetas('activas', this)">Metas Activas</button>
                        <button class="sub-tab-btn" onclick="cambiarSubPestanaMetas('archivadas', this)">Historial Cumplidos</button>
                    </div>
                </div>
                <button onclick="abrirModalMeta()" style="margin-bottom: 5px;">+ Nueva Meta</button>
            </div>

            <div class="metas-grid-compact fade-in" id="contenedor-metas-activas"></div>
            <div class="metas-grid-compact fade-in hidden" id="contenedor-metas-archivadas" style="opacity: 0.85;"></div>
        </div>

        <div id="configuracion" class="tab-content fade-in">
            <div class="config-profile-header">
                <div style="display: flex; align-items: center;"><div class="profile-avatar" id="profile-avatar-display">U</div><div><h2 style="margin:0; font-size: 1.5em;" id="profile-name-display">Usuario</h2><span style="color: var(--text-muted); font-size: 14px;" id="profile-email-display">Sin correo registrado</span></div></div>
                <div style="display: flex; gap: 10px;">
                    <button class="profile-btn btn-edit-profile" onclick="abrirModalPerfil()">Editar Perfil</button>
                    <button class="profile-btn btn-logout" onclick="cerrarSesion()" title="Cerrar Sesión"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg></button>
                </div>
            </div>
            <div class="config-item"><div><h3 style="margin-bottom: 5px;">Modo Oscuro</h3><span style="color: var(--text-muted); font-size: 14px;">Alternar apariencia.</span></div><label class="switch"><input type="checkbox" id="toggle-dark" onchange="alternarModoOscuro()"><span class="slider"></span></label></div>
        </div>
    </div>

    <div id="registro-boveda-modal" class="modal-overlay"><div class="modal-card" style="width: 350px;"><h3 style="color: var(--primary);">Crear Nueva Cuenta</h3><p style="font-size: 13px; color: var(--text-muted); margin-bottom: 20px;">Se generará un archivo en blanco.</p><label style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; display:block;">Crea tu Usuario:</label><input type="text" id="new-boveda-user" placeholder="Ej. juanperez"><label style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; display:block;">Crea tu Contraseña:</label><input type="password" id="new-boveda-pass" placeholder="••••••••"><div class="modal-footer"><button onclick="cerrarModal('registro-boveda-modal')" class="btn-secondary">Cancelar</button><button onclick="generarNuevaBoveda()">Generar y Descargar</button></div></div></div>
    
    <div id="registro-modal" class="modal-overlay"><div class="modal-card" style="width: 400px;">
        <h3>Registrar Movimiento</h3>
        <label style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; display:block;">Tipo de transacción:</label>
        <select id="reg-tipo" onchange="verificarFormularioRegistro()">
            <option value="Ingreso">Ingreso de Dinero (+)</option>
            <option value="Egreso">Gasto / Egreso (-)</option>
            <option value="Ahorro">Ahorro (+)</option>
            <option value="Deuda">Préstamo Recibido (Nueva Deuda)</option>
            <option value="PagoDeuda">Pago de Deuda (-)</option>
        </select>
        
        <div id="subtipo-ahorro-container" class="hidden">
            <label style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; display:block;">¿Destino del Ahorro?</label>
            <select id="reg-subtipo" onchange="verificarDestinoAhorro()">
                <option value="General">Ahorro General (Sin meta específica)</option>
                <option value="Meta">A una Meta específica...</option>
            </select>
            <div id="select-meta-container" class="hidden" style="margin-top: 10px;"><select id="reg-meta-id"><option value="">Selecciona una meta...</option></select></div>
        </div>

        <div id="detalle-container">
            <label style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; display:block;">Detalle <span id="label-detalle-hint" style="font-weight: normal; font-size: 11px;">(Ej. Sueldo, Almuerzo)</span>:</label>
            <input type="text" id="reg-detalle" placeholder="...">
        </div>

        <label style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; display:block;">Monto ($):</label>
        <input type="number" id="reg-monto" placeholder="0.00" step="0.01" min="0" onkeypress="if(event.key === 'Enter') guardarRegistro()">
        
        <div class="modal-footer"><button onclick="cerrarModal('registro-modal')" class="btn-secondary">Cancelar</button><button onclick="guardarRegistro()">Guardar</button></div>
    </div></div>
    
    <div id="activo-modal" class="modal-overlay"><div class="modal-card" style="width: 400px;">
        <h3 style="color: var(--activo);">Registrar Bien / Activo</h3>
        <label style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; display:block;">Nombre del bien:</label>
        <input type="text" id="act-nombre" placeholder="Ej. Automóvil Toyota Yaris">
        
        <label style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; display:block;">Categoría:</label>
        <select id="act-categoria">
            <option value="Vehículo">Vehículo</option>
            <option value="Inmueble">Inmueble / Terreno</option>
            <option value="Tecnología">Tecnología (PC, Móvil)</option>
            <option value="Inversión">Inversión (Acciones, Oro)</option>
            <option value="Otro">Otro</option>
        </select>

        <label style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; display:block;">Valor de mercado actual ($):</label>
        <input type="number" id="act-valor" placeholder="0.00" step="0.01" min="0" onkeypress="if(event.key === 'Enter') guardarActivo()">
        
        <div class="modal-footer"><button onclick="cerrarModal('activo-modal')" class="btn-secondary">Cancelar</button><button onclick="guardarActivo()" style="background: var(--activo);">Registrar Activo</button></div>
    </div></div>

    <div id="meta-modal" class="modal-overlay">
        <div class="modal-card" style="width: 450px;">
            <h3>Crear Nuevo Objetivo</h3>
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px;">
                <div><label style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; display:block;">Nombre del objetivo:</label><input type="text" id="meta-nombre" placeholder="Ej. Laptop"></div>
                <div><label style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; display:block;">Costo ($):</label><input type="number" id="meta-costo" placeholder="0.00" step="0.01" min="0"></div>
            </div>
            <label style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; display:block;">Descripción (Opcional):</label>
            <textarea id="meta-descripcion" placeholder="Detalles del producto..."></textarea>
            
            <div style="display: flex; gap: 15px; align-items: flex-end; margin-bottom: 10px;">
                <div style="width: 35%;">
                    <label style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; display:block;">Ahorro inicial ($):</label>
                    <input type="number" id="meta-ahorrado" placeholder="0.00" step="0.01" min="0" style="height: 43px; margin-bottom: 0;">
                </div>
                <div style="width: 65%;">
                    <label style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; display:block;">Imagen:</label>
                    <div class="custom-file-container" style="margin-bottom: 0;">
                        <label for="meta-imagen" class="custom-file-btn">Seleccionar</label>
                        <span id="meta-file-name" class="file-name-display">Sin imagen</span>
                        <input type="file" id="meta-imagen" accept="image/*" onchange="procesarImagen(event, 'meta-file-name', (base64) => imagenMetaActual = base64)">
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="margin-top: 15px;"><button onclick="cerrarModal('meta-modal')" class="btn-secondary">Cancelar</button><button onclick="guardarMeta()">Crear Meta</button></div>
        </div>
    </div>
    
    <div id="meta-detalle-modal" class="modal-overlay"><div class="modal-card" style="width: 650px; padding: 0; overflow: hidden; display: flex; flex-direction: row; background: var(--bg-card);"><div style="width: 45%; background: #eee; position: relative;"><img id="md-imagen" style="width: 100%; height: 100%; object-fit: cover; position: absolute; top:0; left:0;"><div id="md-badge" class="badge-cumplida hidden" style="position: absolute; top: 15px; left: 15px; font-size: 12px; padding: 6px 12px;">¡LISTA PARA COMPRAR!</div></div><div style="width: 55%; padding: 30px; display: flex; flex-direction: column; justify-content: center; position: relative;"><div id="md-info-principal"><h2 id="md-titulo" style="margin-bottom: 5px; color: var(--primary);">Titulo</h2><div id="md-fecha-creacion" style="font-size: 11px; color: var(--text-muted); margin-bottom: 10px;">Creado el: -</div><div id="md-desc" style="font-size: 14px; color: var(--text-muted); margin-bottom: 20px; line-height: 1.5; max-height: 80px; overflow-y: auto;">Descripción...</div><div style="background: rgba(0,0,0,0.03); padding: 15px; border-radius: 8px; margin-bottom: 20px;"><div style="display: flex; justify-content: space-between; margin-bottom: 10px;"><span style="color: var(--text-main); font-weight: 600;">Costo Total:</span><span style="color: var(--text-main); font-weight: bold;" id="md-costo">$0.00</span></div><div style="display: flex; justify-content: space-between; margin-bottom: 2px;"><span style="font-weight: 600; color: var(--text-muted);">Ahorrado:</span><span style="font-weight: bold; color: var(--primary);" id="md-ahorrado">$0.00</span></div><div style="text-align: right;"><span class="link-historial" id="md-btn-historial" onclick="toggleHistorialMeta()">Ver historial</span></div></div><div class="barra-progreso-mini" style="height: 12px; margin-bottom: 5px;"><div id="md-barra" class="progreso-fill-mini"></div></div><div style="text-align: right; font-size: 12px; font-weight: bold; color: var(--text-muted); margin-bottom: 20px;" id="md-porcentaje">0%</div><button id="btn-archivar-meta" class="hidden" style="width: 100%; background: var(--gold); color: #333;" onclick="archivarMetaActual()">¡Meta Adquirida! Archivar en Historial</button></div><div id="md-historial-seccion" class="hidden" style="flex: 1; display: flex; flex-direction: column;"><h4 style="margin-bottom: 10px; color: var(--text-main); border-bottom: 1px solid var(--border); padding-bottom: 5px;">Historial de Depósitos<span class="link-historial" style="float: right; font-weight: normal;" onclick="toggleHistorialMeta()">Volver a info</span></h4><div id="md-historial-container"></div></div>
        <div style="margin-top: 25px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border); padding-top: 20px;">
            <button onclick="eliminarMetaActual()" class="btn-secondary btn-danger-text" style="padding: 5px 10px;" title="Eliminar definitivamente y retornar fondos"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
            <button onclick="cerrarModal('meta-detalle-modal')" class="btn-secondary">Cerrar</button>
        </div>
        </div></div></div>
    
    <div id="perfil-modal" class="modal-overlay"><div class="modal-card" style="width: 450px;"><h3>Editar Perfil de Usuario</h3><div style="display: flex; gap: 20px; align-items: flex-start; margin-bottom: 20px;"><div style="text-align: center;"><div class="profile-avatar" style="width: 80px; height: 80px; font-size: 32px; margin: 0 auto 10px auto;" id="edit-avatar-preview">U</div><label for="perfil-avatar" class="btn-secondary" style="padding: 5px 10px; font-size: 12px; cursor: pointer; display: inline-block;">Cambiar Foto</label><input type="file" id="perfil-avatar" accept="image/*" onchange="procesarImagen(event, null, (base64) => { imagenPerfilActual = base64; actualizarPreviewAvatar(base64); })"></div><div style="flex: 1;"><label style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; display:block;">Nombres Completos:</label><input type="text" id="perfil-nombres" placeholder="Tu nombre real"><label style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; display:block;">Usuario de Acceso (Solo lectura):</label><input type="text" id="perfil-usuario-readonly" disabled style="background: rgba(0,0,0,0.05);"></div></div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"><div><label style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; display:block;">Correo Electrónico:</label><input type="email" id="perfil-email" placeholder="ejemplo@correo.com"></div><div><label style="font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; display:block;">Teléfono:</label><input type="tel" id="perfil-telefono" placeholder="0999999999"></div></div><div class="modal-footer"><button onclick="cerrarModal('perfil-modal')" class="btn-secondary">Cancelar</button><button onclick="guardarPerfil()">Guardar Cambios</button></div></div></div>

    <script>
        let misDatos = null; let imagenMetaActual = ""; let imagenPerfilActual = ""; let tarjetaActiva = null; let indiceMetaActualVista = null;
        let accionConfirmadaPendiente = null; 

        document.addEventListener('keydown', e => { if(e.key === "Escape") cerrarTodosModales(); });
        document.getElementById('filtro-inicio').addEventListener('change', function() { document.getElementById('filtro-fin').min = this.value; });

        function mostrarAlerta(titulo, mensaje) { document.getElementById('alert-title').innerText = titulo; document.getElementById('alert-message').innerText = mensaje; document.getElementById('custom-alert-modal').style.display = 'flex'; }
        
        function solicitarConfirmacion(mensaje, accionCallback, textoConfirmar = "Eliminar", textoCancelar = "Cancelar", esPeligro = true) {
            document.getElementById('confirm-title').innerText = esPeligro ? "¿Estás seguro?" : "Confirmación";
            document.getElementById('confirm-title').style.color = esPeligro ? "var(--danger)" : "var(--primary)";
            document.getElementById('confirm-message').innerText = mensaje;
            
            const btnConfirm = document.getElementById('btn-confirm-action');
            btnConfirm.innerText = textoConfirmar;
            btnConfirm.style.background = esPeligro ? "var(--danger)" : "var(--primary)";
            
            document.getElementById('btn-confirm-cancel').innerText = textoCancelar;
            
            accionConfirmadaPendiente = accionCallback;
            btnConfirm.onclick = function() {
                if(accionConfirmadaPendiente) accionConfirmadaPendiente();
                cerrarModal('confirm-modal');
            };
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function toggleTohkaModal(mostrar) {
            const modal = document.getElementById('tohka-modal');
            if (mostrar) {
                document.body.classList.add('no-scroll');
                modal.style.display = 'flex';
            } else {
                document.body.classList.remove('no-scroll');
                modal.style.display = 'none';
            }
        }

        function toggleSessionHistory() {
             const cont = document.getElementById('session-history-container');
             if(cont.classList.contains('hidden')) {
                 cont.innerHTML = '';
                 const previousSessions = misDatos.seguridad.historial_sesiones.slice(1);
                 if(previousSessions.length === 0) {
                     cont.innerHTML = '<div class="session-history-item">No hay sesiones anteriores.</div>';
                 } else {
                     previousSessions.forEach(dateIso => {
                         cont.innerHTML += `<div class="session-history-item">Anterior: ${formatearFechaElegante(dateIso)}</div>`;
                     });
                 }
                 cont.classList.remove('hidden');
             } else {
                 cont.classList.add('hidden');
             }
        }

        function actualizarNombreArchivo(input, spanId) { document.getElementById(spanId).textContent = input.files[0] ? input.files[0].name : "Ningún archivo seleccionado"; }
        function procesarImagen(e, spanId, callback) { if(spanId) actualizarNombreArchivo(e.target, spanId); if (e.target.files && e.target.files[0]) { const lector = new FileReader(); lector.onload = evt => callback(evt.target.result); lector.readAsDataURL(e.target.files[0]); } }
        function cerrarTodosModales() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); cerrarDetalleInline(); document.body.classList.remove('no-scroll'); }
        function cerrarModal(id) { document.getElementById(id).style.display = 'none'; if(id === 'tohka-modal') document.body.classList.remove('no-scroll'); }
        function formatearFechaElegante(fechaIso) { if(!fechaIso) return "Primera sesión registrada"; const opciones = { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true }; let fechaFormateada = new Date(fechaIso).toLocaleString('es-ES', opciones); return fechaFormateada.charAt(0).toUpperCase() + fechaFormateada.slice(1); }
        
        function fmtDinero(valor) { return `<div class="fin-align"><span>$${valor.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span></div>`; }

        function calcularSaldosHistoricos() {
            let saldoAcumulado = 0;
            misDatos.datos.transacciones.forEach(tx => {
                if(tx.tipo === 'Ingreso' || tx.tipo === 'Reverso' || tx.tipo === 'Deuda') saldoAcumulado += tx.monto;
                else if(tx.tipo === 'Egreso' || tx.tipo === 'Ahorro' || tx.tipo === 'PagoDeuda') saldoAcumulado -= tx.monto;
                tx.saldo_historico = saldoAcumulado;
            });
        }

        function iniciarSesion() {
            const user = document.getElementById('login-user').value; const pass = document.getElementById('login-pass').value; const fileInput = document.getElementById('login-file').files[0];
            
            if (!user) { mostrarAlerta("Falta Usuario", "Por favor, ingresa tu nombre de usuario."); return; }
            if (!pass) { mostrarAlerta("Falta Contraseña", "Por favor, ingresa tu contraseña."); return; }
            if (!fileInput) { mostrarAlerta("Falta Archivo", "Debes seleccionar tu archivo de bóveda (.json) para continuar."); return; }

            const lector = new FileReader();
            lector.onload = function(e) {
                try {
                    const datos = JSON.parse(e.target.result);
                    if (datos.seguridad.usuario === user && datos.seguridad.clave === pass) {
                        misDatos = datos;
                        if (!misDatos.seguridad.perfil) misDatos.seguridad.perfil = { nombres: "", email: "", telefono: "", avatar: "" };
                        if (!misDatos.datos.metas) misDatos.datos.metas = [];
                        if (!misDatos.datos.activos) misDatos.datos.activos = [];
                        misDatos.datos.metas.forEach(m => { if(!m.estado) m.estado = 'activa'; if(!m.fechaCreacion) m.fechaCreacion = 'Desconocida'; });

                        if (!misDatos.seguridad.historial_sesiones) {
                             misDatos.seguridad.historial_sesiones = [];
                             if(misDatos.seguridad.ultima_sesion) { misDatos.seguridad.historial_sesiones.push(misDatos.seguridad.ultima_sesion); }
                        }
                        const nowIso = new Date().toISOString();
                        misDatos.seguridad.historial_sesiones.unshift(nowIso); 
                        misDatos.seguridad.ultima_sesion = nowIso; 
                        if(misDatos.seguridad.historial_sesiones.length > 5) { misDatos.seguridad.historial_sesiones = misDatos.seguridad.historial_sesiones.slice(0, 5); }

                        document.getElementById('last-session-trigger').textContent = "Última sesión: " + formatearFechaElegante(misDatos.seguridad.historial_sesiones[0]);
                        document.getElementById('login-modal').style.display = 'none'; document.getElementById('app-container').style.display = 'block';
                        if(document.body.classList.contains('dark-mode')) document.getElementById('toggle-dark').checked = true;
                        
                        limpiarFiltrosAvanzados(); popularSelectsAvanzados(); actualizarTodo(); renderizarDatosPerfil();
                    } else { mostrarAlerta("Acceso Denegado", "Credenciales incorrectas para el archivo seleccionado."); }
                } catch (err) { mostrarAlerta("Error de Archivo", "El archivo seleccionado está dañado o no es válido."); }
            }; lector.readAsText(fileInput);
        }

        function cerrarSesion() { 
            misDatos = null; 
            document.getElementById('app-container').style.display = 'none'; 
            document.getElementById('login-modal').style.display = 'flex'; 
            document.getElementById('login-user').value = ''; 
            document.getElementById('login-pass').value = ''; 
            document.getElementById('login-file').value = ''; 
            document.getElementById('login-file-name').textContent = 'Ningún archivo seleccionado'; 
            limpiarFiltrosAvanzados(); 
            cambiarPestana('vista-general', document.querySelector('.tab-btn:first-child')); 
            document.getElementById('session-history-container').classList.add('hidden'); 
        }

        function abrirModalCrearBoveda() { document.getElementById('new-boveda-user').value = ''; document.getElementById('new-boveda-pass').value = ''; document.getElementById('registro-boveda-modal').style.display = 'flex'; }
        function generarNuevaBoveda() {
            const user = document.getElementById('new-boveda-user').value.trim(); const pass = document.getElementById('new-boveda-pass').value.trim();
            if(!user || !pass) { mostrarAlerta("Atención", "Debes ingresar un usuario y contraseña."); return; }
            const nuevaBoveda = { "seguridad": { "usuario": user, "clave": pass, "ultima_sesion": new Date().toISOString(), "perfil": { "nombres": "", "email": "", "telefono": "", "avatar": "" } }, "datos": { "saldo_disponible": 0, "ahorros_totales": 0, "deudas_totales": 0, "transacciones": [], "metas": [], "activos": [] } };
            const blob = new Blob([JSON.stringify(nuevaBoveda, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Boveda_${user}_NUEVA.json`; a.click();
            cerrarModal('registro-boveda-modal'); mostrarAlerta("¡Cuenta Creada!", `Se ha descargado el archivo "Boveda_${user}_NUEVA.json".\nUtilízalo para iniciar sesión.`);
        }

        function cambiarPestana(id, btn) { document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(id).classList.add('active'); btn.classList.add('active'); document.getElementById('botones-dashboard').style.display = (id === 'vista-general') ? 'flex' : 'none'; cerrarDetalleInline(); }
        function clickBannerPatrimonio() { const btnPatrimonio = document.querySelector('.tab-btn[onclick*="patrimonio"]'); if(btnPatrimonio) cambiarPestana('patrimonio', btnPatrimonio); }
        
        function cambiarSubPestanaMetas(tipo, btn) {
            document.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active');
            if(tipo === 'activas') { document.getElementById('contenedor-metas-activas').classList.remove('hidden'); document.getElementById('contenedor-metas-archivadas').classList.add('hidden'); } 
            else { document.getElementById('contenedor-metas-activas').classList.add('hidden'); document.getElementById('contenedor-metas-archivadas').classList.remove('hidden'); }
        }
        function alternarModoOscuro() { document.body.classList.toggle('dark-mode'); }
        
        function toggleDetalleInline(filtro, cardElement) {
            const container = document.getElementById('detalle-inline-container'); const tituloInline = document.getElementById('detalle-inline-titulo');
            if (tarjetaActiva === cardElement) { cerrarDetalleInline(); return; }
            if(tarjetaActiva) tarjetaActiva.classList.remove('active-detail'); cardElement.classList.add('active-detail'); tarjetaActiva = cardElement;
            
            const hoyIso = new Date().toISOString().split('T')[0];
            let titulo = "", datos = [], colorTitulo = "var(--text-main)";
            if (filtro === 'saldo') { titulo = "Liquidez: Actividad de Hoy"; colorTitulo = "var(--ingreso)"; datos = misDatos.datos.transacciones.filter(tx => tx.fechaIso === hoyIso && (tx.tipo === 'Ingreso' || tx.tipo === 'Egreso' || tx.tipo === 'Ahorro' || tx.tipo === 'Reverso' || tx.tipo === 'Deuda' || tx.tipo === 'PagoDeuda')); } 
            else if (filtro === 'egresos') { titulo = "Egresos: Actividad de Hoy"; colorTitulo = "var(--egreso)"; datos = misDatos.datos.transacciones.filter(tx => tx.fechaIso === hoyIso && tx.tipo === 'Egreso'); } 
            else if (filtro === 'ahorros') { titulo = "Ahorros: Actividad de Hoy"; colorTitulo = "var(--primary)"; datos = misDatos.datos.transacciones.filter(tx => tx.fechaIso === hoyIso && tx.tipo === 'Ahorro').map(tx => ({...tx, tipoVisual: 'Ahorro (+)'})); } 
            else if (filtro === 'deudas') { titulo = "Deudas: Actividad de Hoy"; colorTitulo = "var(--deuda)"; datos = misDatos.datos.transacciones.filter(tx => tx.fechaIso === hoyIso && (tx.tipo === 'Deuda' || tx.tipo === 'PagoDeuda')); }
            
            tituloInline.innerText = titulo; tituloInline.style.color = colorTitulo;
            const tbody = document.getElementById('tabla-detalle-inline'); tbody.innerHTML = '';
            if(datos.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: var(--text-muted); padding: 20px;">No hay actividad registrada el día de hoy para esta categoría.</td></tr>'; } 
            else { datos.slice().reverse().forEach(tx => { 
                let color = tx.tipo === 'Egreso' || tx.tipo === 'PagoDeuda' ? 'var(--egreso)' : (tx.tipo === 'Deuda' ? 'var(--deuda)' : 'var(--ingreso)'); 
                if(tx.tipoVisual === 'Ahorro (+)' || tx.esMeta || tx.tipo === 'Ahorro') color = 'var(--primary)'; 
                if(tx.tipo === 'Reverso') color = 'var(--ingreso)';
                let nTipo = tx.tipo === 'Deuda' ? 'Nueva Deuda' : (tx.tipo === 'PagoDeuda' ? 'Pago Deuda' : tx.tipo);
                
                tbody.innerHTML += `<tr><td>${tx.fecha}</td><td>${tx.detalle}</td><td style="color: ${color}; font-weight: 600;">${tx.tipoVisual || nTipo}</td><td style="font-weight: 600;">${fmtDinero(tx.monto)}</td><td style="color: var(--text-muted); font-weight:600;">${fmtDinero(tx.saldo_historico || 0)}</td></tr>`; 
            }); }
            container.classList.add('open');
        }
        function cerrarDetalleInline() { document.getElementById('detalle-inline-container').classList.remove('open'); if(tarjetaActiva) tarjetaActiva.classList.remove('active-detail'); tarjetaActiva = null; }

        function actualizarTodo() {
            calcularSaldosHistoricos();
            let totalIngresos = 0; let totalEgresos = 0; let totalAhorros = 0; let totalDeudas = 0;
            misDatos.datos.transacciones.forEach(tx => { 
                if(tx.tipo === 'Ingreso' || tx.tipo === 'Deuda') totalIngresos += tx.monto; 
                if(tx.tipo === 'Egreso' || tx.tipo === 'PagoDeuda') totalEgresos += tx.monto; 
                if(tx.tipo === 'Ahorro') totalAhorros += tx.monto; 
                if(tx.tipo === 'Reverso' || tx.tipo === 'UsoAhorro') totalAhorros -= tx.monto;
            });

            let totalActivos = 0;
            misDatos.datos.activos.forEach(a => totalActivos += a.valor);
            let patrimonioNeto = (misDatos.datos.saldo_disponible + misDatos.datos.ahorros_totales + totalActivos) - misDatos.datos.deudas_totales;
            document.getElementById('dash-patrimonio-neto').innerText = "$" + patrimonioNeto.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

            animarCifra('dash-saldo', misDatos.datos.saldo_disponible); animarCifra('dash-ahorros', misDatos.datos.ahorros_totales); animarCifra('dash-deudas', misDatos.datos.deudas_totales); animarCifra('dash-egresos', totalEgresos);
            
            let capTotal = misDatos.datos.saldo_disponible + misDatos.datos.ahorros_totales;
            let pctSaldo = capTotal > 0 ? (misDatos.datos.saldo_disponible / capTotal * 100) : 0;
            let pctAhorro = capTotal > 0 ? (misDatos.datos.ahorros_totales / capTotal * 100) : 0;
            let pctDeuda = capTotal > 0 ? (misDatos.datos.deudas_totales / capTotal * 100) : (misDatos.datos.deudas_totales > 0 ? '∞' : 0);
            let pctGasto = totalIngresos > 0 ? (totalEgresos / totalIngresos * 100) : (totalEgresos > 0 ? '∞' : 0);

            document.getElementById('dash-pct-saldo').innerText = pctSaldo !== '∞' ? `${pctSaldo.toFixed(1)}% de tu capital real` : '0% de tu capital real';
            document.getElementById('dash-pct-ahorros').innerText = pctAhorro !== '∞' ? `${pctAhorro.toFixed(1)}% de tu capital real` : '0% de tu capital real';

            let deudaEl = document.getElementById('dash-pct-deudas');
            if(pctDeuda === '∞' || pctDeuda > 100) { deudaEl.innerText = "¡Peligro! Deuda supera el capital"; deudaEl.style.color = "var(--egreso)"; } 
            else { deudaEl.innerText = `Ratio de endeudamiento: ${pctDeuda.toFixed(1)}%`; if(pctDeuda > 40) deudaEl.style.color = "var(--egreso)"; else if(pctDeuda > 20) deudaEl.style.color = "var(--deuda)"; else deudaEl.style.color = "var(--ingreso)"; }

            let gastoEl = document.getElementById('dash-pct-egresos');
            if(pctGasto === '∞') { gastoEl.innerText = "Gastos sin ingresos registrados"; gastoEl.style.color = "var(--egreso)"; } 
            else { gastoEl.innerText = `Ratio de gasto: ${pctGasto.toFixed(1)}% de tus ingresos`; if(pctGasto > 80) gastoEl.style.color = "var(--egreso)"; else if(pctGasto > 50) gastoEl.style.color = "var(--deuda)"; else gastoEl.style.color = "var(--ingreso)"; }

            aplicarFiltrosAvanzados(); renderizarMetasUI(); renderizarActivosUI(); renderizarGraficoPastelCSS(totalIngresos, totalEgresos, totalAhorros);
            if(tarjetaActiva) { const tipoFiltro = tarjetaActiva.onclick.toString().match(/'(.*?)'/)[1]; toggleDetalleInline(tipoFiltro, tarjetaActiva); }
        }
        function animarCifra(id, val) { document.getElementById(id).innerText = "$" + val.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}); }
        
        function renderizarGraficoPastelCSS(tI, tE, tA) {
            let disponible = Math.max(0, misDatos.datos.saldo_disponible);
            const total = disponible + tE + tA;
            if(total === 0) { 
                document.getElementById('css-pie-chart').style.background = 'conic-gradient(var(--border) 0% 100%)'; 
                document.getElementById('total-flujo').innerText = "$0"; 
                document.getElementById('pct-ingreso').innerText = "$0.00 (0%)"; document.getElementById('pct-egreso').innerText = "$0.00 (0%)"; 
                document.getElementById('pct-ahorro').innerText = "$0.00 (0%)"; 
                return; 
            }
            const pI = (disponible/total)*100, pE = (tE/total)*100, pA = (tA/total)*100;
            const degI = (pI/100)*360, degE = degI + (pE/100)*360, degA = degE + (pA/100)*360;
            
            document.getElementById('css-pie-chart').style.background = `conic-gradient(var(--ingreso) 0deg ${degI}deg, var(--egreso) ${degI}deg ${degE}deg, var(--primary) ${degE}deg 360deg)`;
            document.getElementById('total-flujo').innerText = "$" + total.toLocaleString('en-US', {maximumFractionDigits: 0});
            
            document.getElementById('pct-ingreso').innerText = `$${disponible.toLocaleString('en-US', {minimumFractionDigits: 2})} (${pI.toFixed(1)}%)`; 
            document.getElementById('pct-egreso').innerText = `$${tE.toLocaleString('en-US', {minimumFractionDigits: 2})} (${pE.toFixed(1)}%)`; 
            document.getElementById('pct-ahorro').innerText = `$${tA.toLocaleString('en-US', {minimumFractionDigits: 2})} (${pA.toFixed(1)}%)`; 
        }

        function abrirModalActivo() { document.getElementById('act-nombre').value = ''; document.getElementById('act-valor').value = ''; document.getElementById('activo-modal').style.display = 'flex'; }
        function guardarActivo() { const nom = document.getElementById('act-nombre').value.trim(); const cat = document.getElementById('act-categoria').value; const val = parseFloat(document.getElementById('act-valor').value); if(!nom || isNaN(val) || val < 0) { mostrarAlerta("Error", "Ingresa un nombre y valor válido."); return; } misDatos.datos.activos.push({ nombre: nom, categoria: cat, valor: val, fecha: new Date().toLocaleDateString('es-ES') }); actualizarTodo(); cerrarModal('activo-modal'); }
        function renderizarActivosUI() { const cont = document.getElementById('contenedor-activos'); cont.innerHTML = ''; if(misDatos.datos.activos.length === 0) { cont.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-muted);">No tienes activos registrados.</p>'; return; } misDatos.datos.activos.forEach((a, i) => { cont.innerHTML += `<div class="activo-card fade-in"><span class="activo-cat-badge">${a.categoria}</span><h4 class="activo-titulo">${a.nombre}</h4><div class="activo-valor">$${a.valor.toLocaleString('en-US', {minimumFractionDigits: 2})}</div><div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); align-items:center;"><span>Reg: ${a.fecha}</span><button class="btn-secondary btn-danger-text" style="padding: 2px 5px; font-size:10px;" onclick="eliminarActivo(${i})">Eliminar</button></div></div>`; }); }
        
        function eliminarActivo(index) {
            solicitarConfirmacion(
                `¿Deseas eliminar este activo de tu patrimonio?\n(Esta acción no afecta tu saldo líquido, solo tu cálculo de riqueza real).`,
                function() {
                    misDatos.datos.activos.splice(index, 1);
                    actualizarTodo();
                }
            );
        }

        function renderizarDatosPerfil() { const p = misDatos.seguridad.perfil; const nombreMostrar = p.nombres || misDatos.seguridad.usuario; document.getElementById('profile-name-display').textContent = nombreMostrar; document.getElementById('profile-email-display').textContent = p.email || "Sin correo registrado"; const avatarContainer = document.getElementById('profile-avatar-display'); if(p.avatar) { avatarContainer.innerHTML = `<img src="${p.avatar}">`; } else { avatarContainer.innerHTML = nombreMostrar.charAt(0).toUpperCase(); } }
        function abrirModalPerfil() { const p = misDatos.seguridad.perfil; document.getElementById('perfil-usuario-readonly').value = misDatos.seguridad.usuario; document.getElementById('perfil-nombres').value = p.nombres; document.getElementById('perfil-email').value = p.email; document.getElementById('perfil-telefono').value = p.telefono; imagenPerfilActual = p.avatar; actualizarPreviewAvatar(p.avatar); document.getElementById('perfil-modal').style.display = 'flex'; }
        function actualizarPreviewAvatar(base64) { const preview = document.getElementById('edit-avatar-preview'); if(base64) { preview.innerHTML = `<img src="${base64}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`; } else { preview.innerHTML = (document.getElementById('perfil-nombres').value.charAt(0) || misDatos.seguridad.usuario.charAt(0)).toUpperCase(); } }
        function guardarPerfil() { misDatos.seguridad.perfil = { nombres: document.getElementById('perfil-nombres').value, email: document.getElementById('perfil-email').value, telefono: document.getElementById('perfil-telefono').value, avatar: imagenPerfilActual }; renderizarDatosPerfil(); cerrarModal('perfil-modal'); }

        function abrirModalRegistro() { document.getElementById('reg-tipo').value = 'Ingreso'; document.getElementById('reg-subtipo').value = 'General'; document.getElementById('reg-detalle').value = ''; document.getElementById('reg-monto').value = ''; verificarFormularioRegistro(); document.getElementById('registro-modal').style.display = 'flex'; }
        function verificarFormularioRegistro() { const tipo = document.getElementById('reg-tipo').value; const isAhorro = tipo === 'Ahorro'; const hint = document.getElementById('label-detalle-hint'); document.getElementById('detalle-container').classList.toggle('hidden', isAhorro); document.getElementById('subtipo-ahorro-container').classList.toggle('hidden', !isAhorro); if(tipo === 'Deuda') hint.innerText = "(Ej. Préstamo a Juan, Tarjeta Visa)"; else if(tipo === 'PagoDeuda') hint.innerText = "(Ej. Abono a Visa, Pago de préstamo)"; else hint.innerText = "(Ej. Sueldo, Almuerzo)"; if(isAhorro) verificarDestinoAhorro(); }
        function verificarDestinoAhorro() { const subtipo = document.getElementById('reg-subtipo').value; const selectMetaContainer = document.getElementById('select-meta-container'); selectMetaContainer.classList.toggle('hidden', subtipo !== 'Meta'); if (subtipo === 'Meta') { const selectMeta = document.getElementById('reg-meta-id'); selectMeta.innerHTML = '<option value="">Selecciona una meta...</option>'; misDatos.datos.metas.forEach((m, index) => { if(m.estado === 'activa' && m.ahorrado < m.costo) { selectMeta.innerHTML += `<option value="${index}">${m.nombre} (Faltan $${(m.costo - m.ahorrado).toFixed(2)})</option>`; } }); } }
        
        function guardarRegistro() {
            const tipo = document.getElementById('reg-tipo').value; const monto = parseFloat(document.getElementById('reg-monto').value); let detalle = document.getElementById('reg-detalle').value;
            if(isNaN(monto) || monto <= 0) { mostrarAlerta("Error", "Ingresa un monto numérico válido mayor a cero."); return; }
            if(tipo !== 'Ahorro' && !detalle.trim()) { mostrarAlerta("Error", "Debes ingresar un detalle para el movimiento."); return; }
            if(['Egreso', 'Ahorro', 'PagoDeuda'].includes(tipo)) { if(monto > misDatos.datos.saldo_disponible) { mostrarAlerta("Fondos Insuficientes", "No tienes suficiente Liquidez Total (Saldo Disponible) para realizar esta operación."); return; } }
            
            const hoy = new Date(); let metaId = null;
            
            if (tipo === 'Ingreso') { misDatos.datos.saldo_disponible += monto; } 
            else if (tipo === 'Egreso') { misDatos.datos.saldo_disponible -= monto; } 
            else if (tipo === 'Deuda') { misDatos.datos.saldo_disponible += monto; misDatos.datos.deudas_totales += monto; } 
            else if (tipo === 'PagoDeuda') { misDatos.datos.saldo_disponible -= monto; misDatos.datos.deudas_totales = Math.max(0, misDatos.datos.deudas_totales - monto); } 
            else if (tipo === 'Ahorro') { 
                const subtipo = document.getElementById('reg-subtipo').value; 
                
                if(subtipo === 'Meta') { 
                    metaId = document.getElementById('reg-meta-id').value; 
                    if(metaId === "") { mostrarAlerta("Error", "Selecciona la meta destino para tu ahorro."); return; } 
                    
                    let metaSeleccionada = misDatos.datos.metas[metaId];
                    let faltante = metaSeleccionada.costo - metaSeleccionada.ahorrado;
                    if (monto > faltante) {
                        mostrarAlerta("Límite Excedido", `Solo te faltan $${faltante.toLocaleString('en-US', {minimumFractionDigits: 2})} para completar esta meta. No puedes ingresar un monto mayor al faltante.`);
                        return;
                    }

                    misDatos.datos.saldo_disponible -= monto; 
                    misDatos.datos.ahorros_totales += monto; 
                    misDatos.datos.metas[metaId].ahorrado += monto; 
                    detalle = `Ahorro a Meta: ${misDatos.datos.metas[metaId].nombre}`; 
                } else { 
                    misDatos.datos.saldo_disponible -= monto; 
                    misDatos.datos.ahorros_totales += monto; 
                    detalle = "Ahorro General"; 
                } 
            }
            misDatos.datos.transacciones.push({ fecha: hoy.toLocaleDateString('es-ES'), fechaIso: hoy.toISOString().split('T')[0], tipo: tipo, detalle: detalle, monto: monto, metaId: metaId });
            popularSelectsAvanzados(); actualizarTodo(); cerrarModal('registro-modal');
        }

        function abrirModalMeta() { document.getElementById('meta-nombre').value = ''; document.getElementById('meta-costo').value = ''; document.getElementById('meta-ahorrado').value = ''; document.getElementById('meta-descripcion').value = ''; document.getElementById('meta-imagen').value = ''; document.getElementById('meta-file-name').textContent = "Sin imagen"; imagenMetaActual = ""; document.getElementById('meta-modal').style.display = 'flex'; }
        function guardarMeta() { const nom = document.getElementById('meta-nombre').value; const cos = parseFloat(document.getElementById('meta-costo').value); const aho = parseFloat(document.getElementById('meta-ahorrado').value) || 0; const desc = document.getElementById('meta-descripcion').value; if(!nom || isNaN(cos) || cos<=0) { mostrarAlerta("Error", "Ingresa un nombre y un costo total válido."); return; } misDatos.datos.metas.push({ nombre: nom, costo: cos, ahorrado: aho, imagen: imagenMetaActual, descripcion: desc, estado: 'activa', fechaCreacion: new Date().toLocaleDateString('es-ES') }); misDatos.datos.ahorros_totales += aho; popularSelectsAvanzados(); actualizarTodo(); cerrarModal('meta-modal'); }
        function renderizarMetasUI() { const contActivas = document.getElementById('contenedor-metas-activas'); const contArchivadas = document.getElementById('contenedor-metas-archivadas'); contActivas.innerHTML = ''; contArchivadas.innerHTML = ''; let hayActivas = false, hayArchivadas = false; misDatos.datos.metas.forEach((m, i) => { if(m.estado === 'eliminada') return; const porcentaje = Math.min((m.ahorrado / m.costo) * 100, 100); const esCumplida = porcentaje >= 100; const esArchivada = m.estado === 'archivada'; const imgSrc = m.imagen ? m.imagen : 'data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22%23eee%22%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%2F%3E%3C%2Fsvg%3E'; const badge = esArchivada ? '<div class="badge-archivada">ARCHIVADA</div>' : (esCumplida ? '<div class="badge-cumplida">¡LISTA!</div>' : ''); const html = `<div class="meta-card-compact ${esCumplida ? 'cumplida' : ''} ${esArchivada ? 'archivada' : ''}" onclick="abrirDetalleMeta(${i})">${badge}<div class="meta-img-box"><img src="${imgSrc}"></div><div class="meta-info"><div class="meta-title" title="${m.nombre}">${m.nombre}</div><div class="barra-progreso-mini"><div class="progreso-fill-mini" style="width: ${porcentaje}%;"></div></div><div style="font-size:11px; color:var(--text-muted); display:flex; justify-content:space-between;"><span>$${m.ahorrado.toLocaleString('en-US')}</span><span style="font-weight:bold;">${porcentaje.toFixed(0)}%</span></div></div></div>`; if(esArchivada) { contArchivadas.innerHTML += html; hayArchivadas = true; } else { contActivas.innerHTML += html; hayActivas = true; } }); if(!hayActivas) contActivas.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-muted); margin-top:20px;">No tienes objetivos activos.</p>'; if(!hayArchivadas) contArchivadas.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-muted); margin-top:20px;">Aún no tienes objetivos archivados.</p>'; }
        function abrirDetalleMeta(index) { indiceMetaActualVista = index; const m = misDatos.datos.metas[index]; const porcentaje = Math.min((m.ahorrado / m.costo) * 100, 100); document.getElementById('md-info-principal').classList.remove('hidden'); document.getElementById('md-historial-seccion').classList.add('hidden'); document.getElementById('md-imagen').src = m.imagen ? m.imagen : 'data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22%23eee%22%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%2F%3E%3C%2Fsvg%3E'; document.getElementById('md-titulo').innerText = m.nombre; document.getElementById('md-fecha-creacion').innerText = "Creado el: " + (m.fechaCreacion || 'Desconocida'); document.getElementById('md-desc').innerText = m.descripcion || "Sin descripción proporcionada."; document.getElementById('md-ahorrado').innerText = "$" + m.ahorrado.toLocaleString('en-US', {minimumFractionDigits: 2}); document.getElementById('md-costo').innerText = "$" + m.costo.toLocaleString('en-US', {minimumFractionDigits: 2}); document.getElementById('md-barra').style.width = porcentaje + "%"; const badge = document.getElementById('md-badge'); const btnArchivar = document.getElementById('btn-archivar-meta'); badge.classList.add('hidden'); btnArchivar.classList.add('hidden'); if (m.estado === 'archivada') { document.getElementById('md-porcentaje').innerText = "META ARCHIVADA EN HISTORIAL"; document.getElementById('md-porcentaje').style.color = "var(--text-muted)"; document.getElementById('md-barra').style.background = "var(--text-muted)"; } else if (porcentaje >= 100) { document.getElementById('md-porcentaje').innerText = "100% - ¡OBJETIVO CUMPLIDO!"; document.getElementById('md-porcentaje').style.color = "var(--ingreso)"; document.getElementById('md-barra').style.background = "var(--ingreso)"; badge.classList.remove('hidden'); btnArchivar.classList.remove('hidden'); } else { document.getElementById('md-porcentaje').innerText = porcentaje.toFixed(1) + "% COMPLETADO"; document.getElementById('md-porcentaje').style.color = "var(--text-muted)"; document.getElementById('md-barra').style.background = "var(--primary)"; } document.getElementById('meta-detalle-modal').style.display = 'flex'; }
        
        function archivarMetaActual() { 
            const m = misDatos.datos.metas[indiceMetaActualVista];
            solicitarConfirmacion(
                `¿Estás seguro de que deseas archivar la meta "${m.nombre}"?\n\nSe moverá al historial y no podrás añadirle más ahorros.`,
                function() {
                    m.estado = 'archivada'; 
                    actualizarTodo(); 
                    cerrarModal('meta-detalle-modal'); 
                    cambiarSubPestanaMetas('archivadas', document.querySelectorAll('.sub-tab-btn')[1]); 
                    
                    setTimeout(() => {
                        solicitarConfirmacion(
                            `¡Meta archivada!\n\n¿Adquiriste este bien en la vida real y deseas registrar "${m.nombre}" como un nuevo Activo Fijo en tu Patrimonio?\n\n(Esto vaciará los $${m.ahorrado.toLocaleString('en-US')} de tus ahorros y los convertirá en un Activo, equilibrando tu contabilidad).`,
                            function() { 
                                misDatos.datos.activos.push({ nombre: m.nombre, categoria: 'Otro', valor: m.ahorrado, fecha: new Date().toLocaleDateString('es-ES') }); 
                                misDatos.datos.ahorros_totales -= m.ahorrado;
                                misDatos.datos.transacciones.push({
                                    fecha: new Date().toLocaleDateString('es-ES'),
                                    fechaIso: new Date().toISOString().split('T')[0],
                                    tipo: 'UsoAhorro',
                                    detalle: `Compra de activo con fondos de meta: ${m.nombre}`,
                                    monto: m.ahorrado,
                                    metaId: null 
                                });
                                actualizarTodo(); 
                                mostrarAlerta("Permuta de Activo Exitosa", "El dinero ha salido de tus ahorros y el bien físico ha sido añadido exitosamente a tu Patrimonio Neto."); 
                            },
                            "Sí, convertir en Activo",
                            "No, solo archivar",
                            false 
                        );
                    }, 400);
                },
                "Archivar",
                "Cancelar",
                true 
            );
        }
        
        function eliminarMetaActual() { 
            const m = misDatos.datos.metas[indiceMetaActualVista];
            solicitarConfirmacion(
                `¿Deseas eliminar definitivamente la meta "${m.nombre}"?\n\nEl dinero que tenías ahorrado ($${m.ahorrado.toLocaleString('en-US', {minimumFractionDigits: 2})}) regresará a tu Liquidez Total (Saldo Disponible).`,
                function() {
                    const montoReverso = m.ahorrado; misDatos.datos.saldo_disponible += montoReverso; misDatos.datos.ahorros_totales -= montoReverso; if (montoReverso > 0) { const hoy = new Date(); misDatos.datos.transacciones.push({ fecha: hoy.toLocaleDateString('es-ES'), fechaIso: hoy.toISOString().split('T')[0], tipo: 'Reverso', detalle: `Reverso de fondos: Meta eliminada (${m.nombre})`, monto: montoReverso, metaId: null }); } m.ahorrado = 0; m.estado = 'eliminada'; popularSelectsAvanzados(); actualizarTodo(); cerrarModal('meta-detalle-modal'); mostrarAlerta("Meta Eliminada", "La meta ha sido eliminada y los fondos han retornado.");
                }
            );
        }

        function toggleHistorialMeta() {
            const info = document.getElementById('md-info-principal'); const hist = document.getElementById('md-historial-seccion');
            if(hist.classList.contains('hidden')) { 
                info.classList.add('hidden'); hist.classList.remove('hidden'); 
                const container = document.getElementById('md-historial-container'); container.innerHTML = '';
                const txMeta = misDatos.datos.transacciones.filter(tx => tx.tipo === 'Ahorro' && tx.metaId == indiceMetaActualVista); 
                if(txMeta.length === 0) { container.innerHTML = '<p style="color:gray; padding:10px 0; text-align:center; font-size:13px;">No hay depósitos registrados.</p>'; } 
                else { 
                    txMeta.reverse().forEach(tx => { 
                        container.innerHTML += `
                        <div class="historial-item">
                            <span class="historial-fecha">${tx.fecha}</span>
                            <div class="fin-align" style="color: var(--primary); font-weight: bold;">
                                +$${tx.monto.toLocaleString('en-US', {minimumFractionDigits: 2})}
                            </div>
                        </div>`; 
                    }); 
                } 
            } else { hist.classList.add('hidden'); info.classList.remove('hidden'); }
        }

        function popularSelectsAvanzados() {
            const selectAhorro = document.getElementById('filtro-ahorro-select'); selectAhorro.innerHTML = '<option value="Todos">Todos los ahorros</option><option value="General">Ahorro General</option>';
            if(misDatos && misDatos.datos.metas) { misDatos.datos.metas.forEach((m, index) => { 
                if(m.estado === 'activa' || m.estado === 'archivada') selectAhorro.innerHTML += `<option value="${index}">Meta: ${m.nombre}</option>`; 
                else if(m.estado === 'eliminada') selectAhorro.innerHTML += `<option value="${index}">Meta: ${m.nombre} (Eliminada)</option>`; 
            }); }
            const selectDeuda = document.getElementById('filtro-deuda-select'); selectDeuda.innerHTML = '<option value="Todas">Todas las deudas</option>';
            if(misDatos && misDatos.datos.transacciones) { const deudas = misDatos.datos.transacciones.filter(tx => tx.tipo === 'Deuda'); const etiquetas = [...new Set(deudas.map(tx => tx.detalle.trim()))]; etiquetas.forEach(et => { selectDeuda.innerHTML += `<option value="${et}">${et}</option>`; }); }
        }
        function verificarSubfiltrosMovimientos() {
            const tipo = document.getElementById('filtro-tipo').value; const fila = document.getElementById('fila-subfiltros'); const cajaAhorro = document.getElementById('caja-filtro-ahorro'); const cajaDeuda = document.getElementById('caja-filtro-deuda');
            fila.classList.add('hidden'); cajaAhorro.classList.add('hidden'); cajaDeuda.classList.add('hidden');
            if(tipo === 'Ahorro') { fila.classList.remove('hidden'); cajaAhorro.classList.remove('hidden'); } if(tipo === 'Deuda') { fila.classList.remove('hidden'); cajaDeuda.classList.remove('hidden'); }
        }
        function aplicarFiltrosAvanzados() {
            let filtrados = misDatos.datos.transacciones.slice(); const inicio = document.getElementById('filtro-inicio').value; const fin = document.getElementById('filtro-fin').value; const tipo = document.getElementById('filtro-tipo').value;
            if(inicio) filtrados = filtrados.filter(tx => tx.fechaIso >= inicio); if(fin) filtrados = filtrados.filter(tx => tx.fechaIso <= fin);
            if(tipo !== 'Todos') { 
                if(tipo === 'Reverso') { filtrados = filtrados.filter(tx => tx.tipo === 'Reverso'); }
                else if(tipo === 'UsoAhorro') { filtrados = filtrados.filter(tx => tx.tipo === 'UsoAhorro'); }
                else if(tipo === 'Deuda') { filtrados = filtrados.filter(tx => tx.tipo === 'Deuda' || tx.tipo === 'PagoDeuda'); }
                else {
                    filtrados = filtrados.filter(tx => tx.tipo === tipo); 
                    if (tipo === 'Ahorro') { const subAho = document.getElementById('filtro-ahorro-select').value; if(subAho === 'General') { filtrados = filtrados.filter(tx => tx.metaId === null || tx.metaId === undefined); } else if (subAho !== 'Todos') { filtrados = filtrados.filter(tx => tx.metaId == subAho); } } 
                }
            }
            const tbody = document.getElementById('tabla-movimientos'); tbody.innerHTML = '';
            if(filtrados.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px;">No se encontraron movimientos.</td></tr>'; return; }
            filtrados.reverse().forEach(tx => { 
                let color = tx.tipo === 'Egreso' || tx.tipo === 'PagoDeuda' ? 'var(--egreso)' : (tx.tipo === 'Deuda' ? 'var(--deuda)' : 'var(--ingreso)'); 
                let nombreTipo = tx.tipo === 'Ahorro' && tx.metaId != null ? 'Ahorro a Meta' : tx.tipo; 
                if(tx.tipo === 'Deuda') nombreTipo = 'Nueva Deuda';
                if(tx.tipo === 'PagoDeuda') nombreTipo = 'Pago Deuda';
                if(tx.tipo === 'Ahorro') color = 'var(--primary)';
                if(tx.tipo === 'Reverso') color = 'var(--ingreso)';
                if(tx.tipo === 'UsoAhorro') { color = 'var(--text-muted)'; nombreTipo = 'Uso de Ahorros'; }
                tbody.innerHTML += `<tr><td>${tx.fecha}</td><td style="color:${color}; font-weight:600;">${nombreTipo}</td><td>${tx.detalle}</td><td style="font-weight:600;">${fmtDinero(tx.monto)}</td><td style="color: var(--text-muted); font-weight:600;">${fmtDinero(tx.saldo_historico || 0)}</td></tr>`; 
            });
        }
        function limpiarFiltrosAvanzados() { document.getElementById('filtro-inicio').value = ''; document.getElementById('filtro-fin').value = ''; document.getElementById('filtro-tipo').value = 'Todos'; document.getElementById('filtro-ahorro-select').value = 'Todos'; document.getElementById('filtro-deuda-select').value = 'Todas'; verificarSubfiltrosMovimientos(); aplicarFiltrosAvanzados(); }
        function descargarRespaldo() { misDatos.seguridad.ultima_sesion = new Date().toISOString(); const fecha = new Date().toISOString().split('T')[0]; const blob = new Blob([JSON.stringify(misDatos, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Boveda_${misDatos.seguridad.usuario}_${fecha}.json`; a.click(); document.getElementById('last-session-trigger').textContent = "Última sesión: " + formatearFechaElegante(misDatos.seguridad.ultima_sesion); const btnIcon = document.querySelector('.btn-respaldo svg'); btnIcon.style.transform = 'scale(0.8)'; setTimeout(() => btnIcon.style.transform = 'scale(1)', 200); }
        function exportarCSV() { const fechaHoy = new Date().toLocaleDateString('es-ES'); let csv = `"HISTORIAL FINANCIERO - Generado el ${fechaHoy}"\n`; csv += "Fecha,Tipo de Movimiento,Detalle / Descripción,Monto ($), Saldo Post-Movimiento ($)\n"; misDatos.datos.transacciones.forEach(tx => { csv += `"${tx.fecha}","${tx.tipo}","${tx.detalle}","${tx.monto.toFixed(2)}","${(tx.saldo_historico || 0).toFixed(2)}"\n`; }); const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Historial_Financiero_${new Date().toISOString().split('T')[0]}.csv`; a.click(); }
    </script>
</body>

</html>
